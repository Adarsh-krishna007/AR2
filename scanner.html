<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Scanner</title>
    <style>
        #camera {
            width: 100%;
            max-width: 400px;
            height: auto;
            margin: 20px auto;
        }
        #scanner-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #8967B3;
            color: white;
            border: none;
            cursor: pointer;
        }
        #landmark-details {
            margin-top: 20px;
            padding: 10px;
            background-color: #E6D9A2;
            display: none;
        }
    </style>
</head>
<body>
    <div>
        <video id="camera" autoplay></video>
        <button id="scanner-button">Scan</button>
        <div id="landmark-details"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/resemble.js/1.3.0/resemble.min.js"></script>
    <script>
        const video = document.getElementById('camera');
        const scannerButton = document.getElementById('scanner-button');
        const landmarkDetails = document.getElementById('landmark-details');
        let landmarks = [];

        // Get user camera stream
        async function initCamera() {
            let constraints = {
                video: { facingMode: { ideal: 'environment' } } // Try to access the back camera first
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
            } catch (error) {
                // If back camera is not available, fall back to the front camera
                constraints = {
                    video: { facingMode: 'user' }
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
            }
        }

        // Fetch the landmarks database
        async function fetchLandmarks() {
            try {
                const response = await fetch('db.json'); // Ensure db.json is accessible
                landmarks = await response.json();
            } catch (error) {
                console.error('Error fetching landmarks:', error);
            }
        }

        // Function to scan the image from the video feed and compare with the db.json
        async function scanImage() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL(); // Example of captured frame

            let matchedLandmark = null;

            // Compare with each landmark image
            for (const landmark of landmarks) {
                await compareImages(imageData, landmark.image)
                    .then(result => {
                        if (result.rawMisMatchPercentage < 10) { // Set a threshold for matching
                            matchedLandmark = landmark;
                        }
                    });
                if (matchedLandmark) break; // Exit loop if a match is found
            }

            if (matchedLandmark) {
                showLandmarkDetails(matchedLandmark);
            } else {
                // If no match found, perform TensorFlow object detection (to be implemented)
                alert("No matching landmark found. Performing TensorFlow object detection...");
            }
        }

        // Function to compare images
        function compareImages(capturedImage, landmarkImage) {
            return new Promise((resolve) => {
                resemble(capturedImage)
                    .compareTo(landmarkImage)
                    .onComplete((data) => {
                        resolve(data);
                    });
            });
        }

        // Show landmark details
        function showLandmarkDetails(landmark) {
            landmarkDetails.style.display = 'block';
            landmarkDetails.innerHTML = `
                <h3>Landmark: ${landmark.landmark}</h3>
                <p>State: ${landmark.state}</p>
                <p>City: ${landmark.city}</p>
                <p>Locality: ${landmark.locality}</p>
                <img src="${landmark.image}" alt="${landmark.landmark}" width="100%">
            `;
        }

        // Initialize camera and fetch landmarks on page load
        window.onload = async () => {
            await fetchLandmarks();
            initCamera();
        };

        // Add event listener for the scanner button
        scannerButton.addEventListener('click', scanImage);
    </script>
</body>
</html>
